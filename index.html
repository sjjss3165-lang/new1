<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»æ©Ÿç§‘æ™ºæ…§é»é¤çµ±è¨ˆç³»çµ±ğŸ‘©ğŸ¼â€ğŸ³</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --neon-blue: #00d4ff;
            --neon-purple: #9d00ff;
            --bg-dark: #0a0e14;
            --card-bg: rgba(22, 33, 46, 0.98);
            --open: #00ff88;
            --closed: #ff4d4d;
            --gold: #f1c40f;
            --orange: #ff9800;
            --row-paid: rgba(0, 255, 136, 0.15);
        }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 2px 2px, rgba(157, 0, 255, 0.1) 1px, transparent 0);
            background-size: 30px 30px;
            margin: 0; padding: 0; color: #e0e0e0;
        }

        /* ä»‹é¢åˆ‡æ›æ§åˆ¶ */
        #admin-view, #mobile-view { display: none; }

        /* ç®¡ç†ç«¯å°ˆç”¨æ¨£å¼ */
        header { background: rgba(10, 14, 20, 0.98); padding: 1.5rem; text-align: center; border-bottom: 2px solid var(--neon-blue); position: sticky; top: 0; z-index: 1000; }
        h1 { background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; font-size: 1.8rem; }
        .tool-bar { background: rgba(0, 0, 0, 0.7); padding: 15px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .btn-tech { background: transparent; color: var(--neon-blue); border: 1px solid var(--neon-blue); padding: 8px 18px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; text-decoration: none; }
        .btn-tech:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        
        #qr-modal {
            display: none; position: fixed; right: 20px; bottom: 20px; background: #fff; 
            padding: 10px; border-radius: 10px; border: 3px solid var(--neon-purple); 
            z-index: 9999; text-align: center; color: #000;
        }

        /* æ‰‹æ©Ÿç«¯å°ˆç”¨æ¨£å¼ */
        .mobile-container { max-width: 400px; margin: 40px auto; padding: 20px; text-align: center; }
        .mobile-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--neon-blue); background: #000; color: #fff; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 15px; background: var(--neon-blue); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* è¡¨æ ¼èˆ‡å¡ç‰‡æ¨£å¼ (èˆ‡åŸæœ¬ç›¸åŒ) */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid rgba(157, 0, 255, 0.2); position: relative; }
        .order-system { background: rgba(22, 33, 46, 0.98); padding: 30px; border-radius: 12px; margin-top: 50px; border: 1px solid var(--neon-purple); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid rgba(255,255,255,0.05); padding: 12px; text-align: center; }
        input { background: #000; border: 1px solid #333; color: var(--neon-blue); padding: 8px; border-radius: 4px; width: 95%; box-sizing: border-box; }
        tr.new-entry { animation: neon-glow 2s; }
        @keyframes neon-glow { from { background: var(--neon-purple); } to { background: transparent; } }
    </style>
</head>
<body>

<div id="admin-view">
    <header><h1>é›»æ©Ÿç§‘æ™ºæ…§é»é¤çµ±è¨ˆç³»çµ±ğŸ‘©ğŸ¼â€ğŸ³</h1></header>
    
    <div id="qr-modal">
        <div id="qrcode"></div>
        <p style="margin: 5px 0 0; font-size: 12px;">åŒå­¸æƒæé»é¤</p>
    </div>

    <div class="tool-bar">
        <button class="btn-tech" onclick="openWheel('drink')">ğŸ¥¤ æŠ½é£²æ–™</button>
        <button class="btn-tech" onclick="openWheel('food')">ğŸœ æŠ½ç¾é£Ÿ</button>
        <button class="btn-tech" onclick="renderStores()">ğŸ”„ åˆ·æ–°ç‹€æ…‹</button>
    </div>

    <div class="container">
        <div id="drinks-grid" class="grid"></div>
        <div class="order-system">
            <h2 style="color:var(--neon-purple);">ğŸ“Š å³æ™‚é›²ç«¯çµ±è¨ˆè¡¨</h2>
            <input type="text" id="target-store-input" style="border:none; border-bottom:2px solid var(--gold); color:var(--gold); font-size:1.2rem; width:50%; background:transparent;" placeholder="ç­‰å¾…é¸å–åº—å®¶...">
            <table id="orderTable">
                <thead>
                    <tr><th>æ”¶éŒ¢</th><th>åå–®</th><th>å“é …å‚™è¨»</th><th>æ‡‰ä»˜</th><th>æ”¶å¤šå°‘</th><th>æ‡‰æ‰¾</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <div style="text-align:right; font-size:1.8rem; color:var(--neon-blue); margin-top:20px;">ç¸½é‡‘é¡ï¼š$<span id="finalPrice">0</span></div>
        </div>
    </div>
</div>

<div id="mobile-view">
    <div class="mobile-container">
        <h2 style="color:var(--neon-purple);">âš¡ï¸ é›»æ©Ÿç§‘è¡Œå‹•é»é¤</h2>
        <div id="mobile-store-name" style="color:var(--gold); font-size:1.4rem; margin:20px 0;">ç­‰å¾…è€å¸«é–‹å•Ÿ...</div>
        <input type="text" id="uName" class="mobile-input" placeholder="ä½ çš„å§“å">
        <input type="text" id="uItem" class="mobile-input" placeholder="æƒ³å–ä»€éº¼ï¼Ÿ(ç³–å†°å‚™è¨»)">
        <input type="number" id="uPrice" class="mobile-input" placeholder="é‡‘é¡ $">
        <button class="btn-submit" onclick="sendToFirebase()">é€å‡ºé»é¤ ğŸš€</button>
    </div>
</div>

<script type="module">
    // --- Firebase é…ç½® (ä½ çš„é‡‘é‘°) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onChildAdded, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC5kL_EtZ5njzrVF91_AX5GlqZDm7Y4gkg",
        authDomain: "bvjvj-a2b27.firebaseapp.com",
        projectId: "bvjvj-a2b27",
        storageBucket: "bvjvj-a2b27.firebasestorage.app",
        messagingSenderId: "5684762832",
        appId: "1:5684762832:web:e324f0c906e4b0313526d5",
        measurementId: "G-1XDKY396FP",
        databaseURL: "https://bvjvj-a2b27-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- åˆ¤æ–·ç›®å‰æ˜¯å“ªç¨®æ¨¡å¼ ---
    const urlParams = new URLSearchParams(window.location.search);
    const isMobile = urlParams.get('mode') === 'mobile';

    if (isMobile) {
        document.getElementById('mobile-view').style.display = 'block';
        // ç›£è½ç›®å‰åº—å®¶
        onValue(ref(db, 'currentStore'), (snapshot) => {
            const data = snapshot.val();
            document.getElementById('mobile-store-name').innerText = data ? "ç›®æ¨™ï¼š" + data.name : "è€å¸«å°šæœªé¸å–åº—å®¶";
        });
        
        window.sendToFirebase = () => {
            const name = document.getElementById('uName').value;
            const item = document.getElementById('uItem').value;
            const price = document.getElementById('uPrice').value;
            if(!name || !item || !price) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼");
            push(ref(db, 'incomingOrders'), { name, item, price });
            alert("é»é¤å·²é€å‡ºï¼");
        };
    } else {
        document.getElementById('admin-view').style.display = 'block';
        // ç®¡ç†ç«¯ç›£è½æ‰‹æ©Ÿå‚³ä¾†çš„è¨‚å–®
        onChildAdded(ref(db, 'incomingOrders'), (snapshot) => {
            const data = snapshot.val();
            if(data) {
                appendOrderRow(data.name, data.item, data.price);
                remove(ref(db, `incomingOrders/${snapshot.key}`));
            }
        });
    }

    // --- å…¨åŸŸè®Šæ•¸ä¾›åŸæœ¬é‚è¼¯ä½¿ç”¨ ---
    window.updateCloudStore = (name) => {
        set(ref(db, 'currentStore'), { name: name });
    };
</script>

<script>
    // --- åŸæœ¬çš„é›»æ©Ÿç§‘é‚è¼¯ ---
    const stores = [
        { name: "å¯ä¸å¯ åŸºéš†æ·±æºªåº—", tel: "0224659695", link: "https://kebuke.com/menu/", cat: "drink", hot: true, time: { all: ["10:00", "22:00"] } },
        { name: "50åµ åŸºéš†æ·±æºªåº—", tel: "0224683368", link: "https://order.nidin.shop/menu/21216", cat: "drink", hot: true, time: { all: ["10:00", "22:00"] } },
        // ... å…¶ä»–åº—å®¶è³‡æ–™ ...
    ];

    function handleAction(e, storeName) {
        document.getElementById('target-store-input').value = storeName;
        
        // 1. åŒæ­¥é›²ç«¯
        if(window.updateCloudStore) window.updateCloudStore(storeName);
        
        // 2. ç”Ÿæˆ QR Code (æŒ‡å‘åŒä¸€å€‹æª”æ¡ˆä½†åŠ ä¸Šåƒæ•¸)
        const qrBox = document.getElementById('qrcode');
        qrBox.innerHTML = "";
        const mobileUrl = window.location.origin + window.location.pathname + "?mode=mobile";
        new QRCode(qrBox, { text: mobileUrl, width: 120, height: 120 });
        document.getElementById('qr-modal').style.display = "block";
        return true;
    }

    function appendOrderRow(name, item, price) {
        const tbody = document.querySelector("#orderTable tbody");
        const row = tbody.insertRow(0);
        row.className = "new-entry";
        row.innerHTML = `
            <td><input type="checkbox"></td>
            <td><input type="text" value="${name}"></td>
            <td><input type="text" value="${item}"></td>
            <td><input type="number" class="price-val" value="${price}" oninput="calculate()"></td>
            <td><input type="number" class="received-val" oninput="calculate()"></td>
            <td class="change-cell">0</td>
            <td><button onclick="this.closest('tr').remove();calculate()">âŒ</button></td>
        `;
        calculate();
    }

    function calculate() {
        let total = 0;
        document.querySelectorAll("#orderTable tbody tr").forEach(row => {
            let p = Number(row.querySelector(".price-val").value) || 0;
            let r = Number(row.querySelector(".received-val").value) || 0;
            total += p;
            row.querySelector(".change-cell").innerText = (r - p) > 0 ? (r - p) : 0;
        });
        document.getElementById("finalPrice").innerText = total;
    }

    function renderStores() {
        const dG = document.getElementById('drinks-grid');
        dG.innerHTML = '';
        stores.forEach(s => {
            dG.innerHTML += `
                <div class="card">
                    <h3 style="color:var(--neon-blue);">${s.name}</h3>
                    <button class="btn-tech" onclick="handleAction(event, '${s.name}')">é¸æ“‡æ­¤åº—å®¶ä¸¦é–‹å•Ÿé»é¤</button>
                </div>`;
        });
    }

    window.onload = () => { if(!new URLSearchParams(window.location.search).get('mode')) renderStores(); };
</script>
</body>
</html>
